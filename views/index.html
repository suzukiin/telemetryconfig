<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Telemetria - Raspberry Pi</title>
  <link rel="stylesheet" href="/style.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <div class="background-overlay"></div>
  
  <!-- Header Principal -->
  <div class="main-header">
    <div class="header-content">
      <div class="header-left">
        <i class="fas fa-raspberry-pi header-icon"></i>
        <div>
          <h1>Dashboard Telemetria</h1>
          <p class="subtitle">Raspberry Pi - Sistema de Monitoramento SNMP</p>
        </div>
      </div>
      <div class="header-right">
        <div class="status-indicator online">
          <i class="fas fa-circle"></i>
          Online
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Principal -->
  <div class="dashboard">
    
    <!-- Seção de Status do Sistema -->
    <div class="dashboard-section">
      <div class="section-header">
        <i class="fas fa-tachometer-alt"></i>
        <h2>Status do Sistema</h2>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-network-wired"></i>
          </div>
          <div class="stat-content">
            <h3>IP Tailscale</h3>
            <p class="stat-value" id="tailscale-ip">Carregando...</p>
            <span class="stat-label">Endereço da VPN</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon temperature">
            <i class="fas fa-thermometer-half"></i>
          </div>
          <div class="stat-content">
            <h3>Temperatura CPU</h3>
            <p class="stat-value" id="cpu-temp">--°C</p>
            <span class="stat-label">Temperatura atual</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-memory"></i>
          </div>
          <div class="stat-content">
            <h3>Uso de RAM</h3>
            <p class="stat-value" id="ram-usage">--%</p>
            <span class="stat-label">Memória utilizada</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-hdd"></i>
          </div>
          <div class="stat-content">
            <h3>Armazenamento</h3>
            <p class="stat-value" id="disk-usage">--%</p>
            <span class="stat-label">Espaço utilizado</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-content">
            <h3>Uptime</h3>
            <p class="stat-value" id="uptime">--</p>
            <span class="stat-label">Tempo ativo</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-wifi"></i>
          </div>
          <div class="stat-content">
            <h3>Conectividade</h3>
            <p class="stat-value" id="connectivity">Verificando...</p>
            <span class="stat-label">Status da rede</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Seção de Status do Equipamento SNMP -->
    <div class="dashboard-section">
      <div class="section-header">
        <i class="fas fa-broadcast-tower"></i>
        <h2>Status do Equipamento (EC710LP)</h2>
        <div class="equipment-status" id="equipment-status">
          <span class="status-badge" id="equipment-badge">Carregando...</span>
        </div>
      </div>
      
      <div class="section-content" id="equipment-section">
        <!-- Medições Principais -->
        <div class="measurements-grid">
          <div class="measurement-card power" data-key="forwardPower">
            <div class="measurement-icon">
              <i class="fas fa-bolt"></i>
            </div>
            <div class="measurement-content">
              <h3>Potência Direta</h3>
              <p class="measurement-value" id="forwardPower">-- W</p>
              <span class="measurement-description">Potência RF total de saída</span>
            </div>
          </div>

          <div class="measurement-card power" data-key="reflectedPower">
            <div class="measurement-icon">
              <i class="fas fa-undo-alt"></i>
            </div>
            <div class="measurement-content">
              <h3>Potência Refletida</h3>
              <p class="measurement-value" id="reflectedPower">-- W</p>
              <span class="measurement-description">Potência RF refletida</span>
            </div>
          </div>

          <div class="measurement-card temperature" data-key="paTemperature">
            <div class="measurement-icon">
              <i class="fas fa-thermometer-half"></i>
            </div>
            <div class="measurement-content">
              <h3>Temperatura PA</h3>
              <p class="measurement-value" id="paTemperature">-- °C</p>
              <span class="measurement-description">Amplificador de potência</span>
            </div>
          </div>

          <div class="measurement-card current" data-key="paCurrent">
            <div class="measurement-icon">
              <i class="fas fa-tachometer-alt"></i>
            </div>
            <div class="measurement-content">
              <h3>Corrente PA</h3>
              <p class="measurement-value" id="paCurrent">-- A</p>
              <span class="measurement-description">Consumo do amplificador</span>
            </div>
          </div>
        </div>

        <!-- Alarmes Ativos -->
        <div class="alarms-section">
          <div class="alarms-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Alarmes Ativos</h3>
            <div class="alarm-summary">
              <span class="alarm-count critical" id="critical-alarms">0</span>
              <span class="alarm-count warning" id="warning-alarms">0</span>
            </div>
          </div>
          <div class="alarms-container" id="alarms-container">
            <div class="no-alarms" id="no-alarms">
              <i class="fas fa-check-circle"></i>
              <span>Nenhum alarme ativo</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let systemData = {};
    let equipmentData = {};

    // Função para atualizar dados do sistema via API
    async function updateSystemStats() {
      try {
        const response = await fetch('/api/system-data');
        const data = await response.json();
        
        if (response.ok) {
          systemData = data;
          
          // Atualizar IP Tailscale
          document.getElementById('tailscale-ip').textContent = data.tailscaleIP;
          
          // Atualizar temperatura com cores baseadas no valor
          const tempElement = document.getElementById('cpu-temp');
          tempElement.textContent = data.cpuTemp !== 'N/A' ? `${data.cpuTemp}°C` : 'N/A';
          const tempCard = tempElement.closest('.stat-card');
          tempCard.classList.remove('warning', 'critical');
          
          if (data.cpuTemp !== 'N/A') {
            const temp = parseFloat(data.cpuTemp);
            if (temp > 70) {
              tempCard.classList.add('critical');
            } else if (temp > 60) {
              tempCard.classList.add('warning');
            }
          }
          
          // Atualizar outros dados
          document.getElementById('ram-usage').textContent = `${data.ramUsage}%`;
          document.getElementById('disk-usage').textContent = `${data.diskUsage}%`;
          document.getElementById('uptime').textContent = data.uptime;
          document.getElementById('connectivity').textContent = data.connectivity;
          
          // Atualizar indicador de status
          const statusIndicator = document.querySelector('.status-indicator');
          if (data.connectivity === 'Estável') {
            statusIndicator.className = 'status-indicator online';
            statusIndicator.innerHTML = '<i class="fas fa-circle"></i> Online';
          } else {
            statusIndicator.className = 'status-indicator offline';
            statusIndicator.innerHTML = '<i class="fas fa-circle"></i> Offline';
          }
          
          console.log('✅ Dados do sistema atualizados:', data);
        } else {
          console.error('❌ Erro ao obter dados do sistema:', data);
          showError('Erro ao carregar dados do sistema');
        }
      } catch (error) {
        console.error('❌ Erro na requisição:', error);
        showError('Erro de conectividade com o servidor');
      }
    }

    // Função para atualizar dados do equipamento via API
    async function updateEquipmentData() {
      try {
        const response = await fetch('/api/equipment-data');
        const data = await response.json();
        
        if (response.ok) {
          equipmentData = data;
          
          const equipmentBadge = document.getElementById('equipment-badge');
          
          if (data.configured) {
            equipmentBadge.className = 'status-badge online';
            equipmentBadge.textContent = 'Conectado';
            
            // Atualizar medições
            updateMeasurements(data.measurements);
            
            // Atualizar alarmes
            updateAlarms(data.alarms);
            
            console.log('✅ Dados do equipamento atualizados:', data);
            
            if (data.errors && data.errors.length > 0) {
              console.warn('⚠️ Alguns erros ao ler dados:', data.errors);
            }
            
          } else {
            equipmentBadge.className = 'status-badge offline';
            equipmentBadge.textContent = 'Não Configurado';
            showNoEquipmentData();
          }
          
        } else {
          console.error('❌ Erro ao obter dados do equipamento:', data);
          const equipmentBadge = document.getElementById('equipment-badge');
          equipmentBadge.className = 'status-badge error';
          equipmentBadge.textContent = 'Erro';
          showNoEquipmentData();
        }
      } catch (error) {
        console.error('❌ Erro na requisição dos dados do equipamento:', error);
        const equipmentBadge = document.getElementById('equipment-badge');
        equipmentBadge.className = 'status-badge error';
        equipmentBadge.textContent = 'Erro';
        showNoEquipmentData();
      }
    }

    function updateMeasurements(measurements) {
      const measurementKeys = ['forwardPower', 'reflectedPower', 'paTemperature', 'paCurrent'];
      
      measurementKeys.forEach(key => {
        const element = document.getElementById(key);
        const card = document.querySelector(`[data-key="${key}"]`);
        
        if (measurements[key]) {
          const measurement = measurements[key];
          element.textContent = `${measurement.value} ${measurement.unit}`;
          
          // Aplicar classes de status baseadas no tipo e valor
          card.classList.remove('normal', 'warning', 'critical');
          
          if (key === 'paTemperature') {
            const temp = parseFloat(measurement.value);
            if (temp > 90) card.classList.add('critical');
            else if (temp > 75) card.classList.add('warning');
            else card.classList.add('normal');
          } else if (key === 'reflectedPower') {
            const power = parseFloat(measurement.value);
            if (power > 50) card.classList.add('warning');
            else card.classList.add('normal');
          } else if (key === 'satelliteTunerStatus') {
            if (measurement.value === 'Locked') card.classList.add('normal');
            else card.classList.add('warning');
          } else {
            card.classList.add('normal');
          }
          
        } else {
          element.textContent = '-- N/A';
          card.classList.remove('normal', 'warning', 'critical');
          card.classList.add('offline');
        }
      });
    }

    function updateAlarms(alarms) {
      const alarmsContainer = document.getElementById('alarms-container');
      const noAlarms = document.getElementById('no-alarms');
      const criticalCount = document.getElementById('critical-alarms');
      const warningCount = document.getElementById('warning-alarms');
      
      // Contar alarmes por severidade
      let criticalAlarms = 0;
      let warningAlarms = 0;
      const activeAlarms = [];
      
      Object.keys(alarms).forEach(key => {
        const alarm = alarms[key];
        if (alarm.active) {
          activeAlarms.push(alarm);
          if (alarm.severity === 'critical') criticalAlarms++;
          else if (alarm.severity === 'warning') warningAlarms++;
        }
      });
      
      // Atualizar contadores
      criticalCount.textContent = criticalAlarms;
      warningCount.textContent = warningAlarms;
      
      // Limpar container
      alarmsContainer.innerHTML = '';
      
      if (activeAlarms.length === 0) {
        alarmsContainer.appendChild(noAlarms);
      } else {
        activeAlarms.forEach(alarm => {
          const alarmElement = document.createElement('div');
          alarmElement.className = `alarm-item ${alarm.severity}`;
          alarmElement.innerHTML = `
            <div class="alarm-icon">
              <i class="fas ${alarm.severity === 'critical' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle'}"></i>
            </div>
            <div class="alarm-content">
              <h4>${alarm.name}</h4>
              <p>${alarm.description}</p>
              <span class="alarm-type">${alarm.type}</span>
            </div>
          `;
          alarmsContainer.appendChild(alarmElement);
        });
      }
    }

    function showNoEquipmentData() {
      // Limpar todas as medições
      const measurementKeys = ['forwardPower', 'reflectedPower', 'paTemperature', 'paCurrent'];
      
      measurementKeys.forEach(key => {
        const element = document.getElementById(key);
        const card = document.querySelector(`[data-key="${key}"]`);
        element.textContent = '-- N/A';
        card.classList.remove('normal', 'warning', 'critical');
        card.classList.add('offline');
      });
      
      // Limpar alarmes
      const alarmsContainer = document.getElementById('alarms-container');
      const noAlarms = document.getElementById('no-alarms');
      alarmsContainer.innerHTML = '';
      alarmsContainer.appendChild(noAlarms);
      
      document.getElementById('critical-alarms').textContent = '0';
      document.getElementById('warning-alarms').textContent = '0';
    }

    function showError(message) {
      // Mostrar dados como "Erro" em caso de falha
      document.getElementById('tailscale-ip').textContent = 'Erro';
      document.getElementById('cpu-temp').textContent = 'N/A';
      document.getElementById('ram-usage').textContent = '-%';
      document.getElementById('disk-usage').textContent = '-%';
      document.getElementById('uptime').textContent = 'N/A';
      document.getElementById('connectivity').textContent = 'Erro';
      
      // Adicionar toast de erro (opcional)
      console.warn('⚠️', message);
    }

    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      const button = event.target.closest('.toggle-section');
      const icon = button.querySelector('i');
      
      section.classList.toggle('collapsed');
      
      if (section.classList.contains('collapsed')) {
        icon.style.transform = 'rotate(-90deg)';
      } else {
        icon.style.transform = 'rotate(0deg)';
      }
    }

    // Inicializar dados do sistema
    updateSystemStats();
    updateEquipmentData();
    
    // Atualizar dados do sistema a cada 30 segundos
    setInterval(updateSystemStats, 30000);
    
    // Atualizar dados do equipamento a cada 15 segundos (mais frequente para alarmes)
    setInterval(updateEquipmentData, 15000);
  </script>
</body>
</html>
