<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Telemetria - Raspberry Pi</title>
  <link rel="stylesheet" href="/style.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body>
  <div class="background-overlay"></div>
  
  <!-- Header Principal -->
  <div class="main-header">
    <div class="header-content">
      <div class="header-left">
        <i class="fas fa-raspberry-pi header-icon"></i>
        <div>
          <h1>Dashboard Telemetria</h1>
          <p class="subtitle">Raspberry Pi - Sistema de Monitoramento SNMP</p>
        </div>
      </div>
      <div class="header-right">
        <div class="status-indicator online">
          <i class="fas fa-circle"></i>
          Online
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Principal -->
  <div class="dashboard">
    
    <!-- Seção de Status do Sistema -->
    <div class="dashboard-section">
      <div class="section-header">
        <i class="fas fa-tachometer-alt"></i>
        <h2>Status do Sistema</h2>
      </div>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-network-wired"></i>
          </div>
          <div class="stat-content">
            <h3>IP Tailscale</h3>
            <p class="stat-value" id="tailscale-ip">Carregando...</p>
            <span class="stat-label">Endereço da VPN</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon temperature">
            <i class="fas fa-thermometer-half"></i>
          </div>
          <div class="stat-content">
            <h3>Temperatura CPU</h3>
            <p class="stat-value" id="cpu-temp">--°C</p>
            <span class="stat-label">Temperatura atual</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-memory"></i>
          </div>
          <div class="stat-content">
            <h3>Uso de RAM</h3>
            <p class="stat-value" id="ram-usage">--%</p>
            <span class="stat-label">Memória utilizada</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-hdd"></i>
          </div>
          <div class="stat-content">
            <h3>Armazenamento</h3>
            <p class="stat-value" id="disk-usage">--%</p>
            <span class="stat-label">Espaço utilizado</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-content">
            <h3>Uptime</h3>
            <p class="stat-value" id="uptime">--</p>
            <span class="stat-label">Tempo ativo</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-wifi"></i>
          </div>
          <div class="stat-content">
            <h3>Conectividade</h3>
            <p class="stat-value" id="connectivity">Verificando...</p>
            <span class="stat-label">Status da rede</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Seção de Status do Equipamento SNMP -->
    <div class="dashboard-section">
      <div class="section-header">
        <i class="fas fa-broadcast-tower"></i>
        <h2>Status do Equipamento (EC710LP)</h2>
        <div class="equipment-status" id="equipment-status">
          <span class="status-badge" id="equipment-badge">Carregando...</span>
        </div>
      </div>
      
      <div class="section-content" id="equipment-section">
        <!-- Medições Principais -->
        <div class="measurements-grid">
          <div class="measurement-card power" data-key="forwardPower">
            <div class="measurement-icon">
              <i class="fas fa-bolt"></i>
            </div>
            <div class="measurement-content">
              <h3>Potência Direta</h3>
              <p class="measurement-value" id="forwardPower">-- W</p>
              <span class="measurement-description">Potência RF total de saída</span>
            </div>
          </div>

          <div class="measurement-card power" data-key="reflectedPower">
            <div class="measurement-icon">
              <i class="fas fa-undo-alt"></i>
            </div>
            <div class="measurement-content">
              <h3>Potência Refletida</h3>
              <p class="measurement-value" id="reflectedPower">-- W</p>
              <span class="measurement-description">Potência RF refletida</span>
            </div>
          </div>

          <div class="measurement-card temperature" data-key="paTemperature">
            <div class="measurement-icon">
              <i class="fas fa-thermometer-half"></i>
            </div>
            <div class="measurement-content">
              <h3>Temperatura PA</h3>
              <p class="measurement-value" id="paTemperature">-- °C</p>
              <span class="measurement-description">Amplificador de potência</span>
            </div>
          </div>

          <div class="measurement-card current" data-key="paCurrent">
            <div class="measurement-icon">
              <i class="fas fa-tachometer-alt"></i>
            </div>
            <div class="measurement-content">
              <h3>Corrente PA</h3>
              <p class="measurement-value" id="paCurrent">-- A</p>
              <span class="measurement-description">Consumo do amplificador</span>
            </div>
          </div>

          <div class="measurement-card voltage" data-key="powerSupply1_50v">
            <div class="measurement-icon">
              <i class="fas fa-plug"></i>
            </div>
            <div class="measurement-content">
              <h3>Fonte 1 (+50V)</h3>
              <p class="measurement-value" id="powerSupply1_50v">-- V</p>
              <span class="measurement-description">Tensão fonte principal</span>
            </div>
          </div>

          <div class="measurement-card voltage" data-key="powerSupply2_50v">
            <div class="measurement-icon">
              <i class="fas fa-plug"></i>
            </div>
            <div class="measurement-content">
              <h3>Fonte 2 (+50V)</h3>
              <p class="measurement-value" id="powerSupply2_50v">-- V</p>
              <span class="measurement-description">Tensão fonte backup</span>
            </div>
          </div>

          <div class="measurement-card signal" data-key="satelliteTunerSnr">
            <div class="measurement-icon">
              <i class="fas fa-satellite"></i>
            </div>
            <div class="measurement-content">
              <h3>SNR Satélite</h3>
              <p class="measurement-value" id="satelliteTunerSnr">-- dB</p>
              <span class="measurement-description">Relação sinal/ruído</span>
            </div>
          </div>

          <div class="measurement-card status" data-key="satelliteTunerStatus">
            <div class="measurement-icon">
              <i class="fas fa-satellite-dish"></i>
            </div>
            <div class="measurement-content">
              <h3>Status Sintonizador</h3>
              <p class="measurement-value" id="satelliteTunerStatus">--</p>
              <span class="measurement-description">Lock do sintonizador</span>
            </div>
          </div>
        </div>

        <!-- Alarmes Ativos -->
        <div class="alarms-section">
          <div class="alarms-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Alarmes Ativos</h3>
            <div class="alarm-summary">
              <span class="alarm-count critical" id="critical-alarms">0</span>
              <span class="alarm-count warning" id="warning-alarms">0</span>
            </div>
          </div>
          <div class="alarms-container" id="alarms-container">
            <div class="no-alarms" id="no-alarms">
              <i class="fas fa-check-circle"></i>
              <span>Nenhum alarme ativo</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Seção de Configuração SNMP -->
    <div class="dashboard-section">
      <div class="section-header">
        <i class="fas fa-cogs"></i>
        <h2>Configuração SNMP</h2>
        <button class="toggle-section" onclick="toggleSection('config-section')">
          <i class="fas fa-chevron-down"></i>
        </button>
      </div>
      
      <div class="section-content" id="config-section">
        <form action="/salvar" method="POST" class="telemetry-form">
          <div class="form-row">
            <div class="form-group">
              <label for="ip">
                <i class="fas fa-server"></i>
                IP do Equipamento
              </label>
              <input type="text" id="ip" name="ip" placeholder="Ex: 192.168.1.100" required>
              <span class="input-hint">Endereço IP do dispositivo a ser monitorado</span>
            </div>

            <div class="form-group">
              <label for="comunidade">
                <i class="fas fa-key"></i>
                Comunidade SNMP
              </label>
              <input type="text" id="comunidade" name="comunidade" placeholder="Ex: public" required>
              <span class="input-hint">String de comunidade para autenticação SNMP</span>
            </div>
          </div>

          <div class="form-group">
            <label for="oids">
              <i class="fas fa-list"></i>
              OIDs para Monitoramento
            </label>
            <textarea id="oids" name="oids" placeholder="Ex: 1.3.6.1.2.1.1.1.0, 1.3.6.1.2.1.2.2.1.10" required></textarea>
            <span class="input-hint">Object Identifiers separados por vírgula</span>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="intervalo">
                <i class="fas fa-clock"></i>
                Intervalo de Coleta
              </label>
              <div class="input-with-unit">
                <input type="number" id="intervalo" name="intervalo" placeholder="60" required min="1" max="3600">
                <span class="unit">segundos</span>
              </div>
              <span class="input-hint">Intervalo entre coletas (1 a 3600 segundos)</span>
            </div>

            <div class="form-group">
              <label for="timeout">
                <i class="fas fa-hourglass-half"></i>
                Timeout SNMP
              </label>
              <div class="input-with-unit">
                <input type="number" id="timeout" name="timeout" placeholder="5" required min="1" max="30">
                <span class="unit">segundos</span>
              </div>
              <span class="input-hint">Tempo limite para resposta SNMP</span>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="resetForm()">
              <i class="fas fa-undo"></i>
              Limpar
            </button>
            <button type="button" class="btn btn-info" onclick="testConnection()">
              <i class="fas fa-plug"></i>
              Testar Conexão
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i>
              Salvar Configuração
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Seção de Log de Atividades -->
    <div class="dashboard-section">
      <div class="section-header">
        <i class="fas fa-list-alt"></i>
        <h2>Log de Atividades</h2>
        <button class="toggle-section" onclick="toggleSection('log-section')">
          <i class="fas fa-chevron-down"></i>
        </button>
      </div>
      
      <div class="section-content collapsed" id="log-section">
        <div class="log-container">
          <div class="log-controls">
            <button class="btn btn-sm" onclick="clearLog()">
              <i class="fas fa-trash"></i>
              Limpar Log
            </button>
            <button class="btn btn-sm" onclick="refreshLog()">
              <i class="fas fa-sync-alt"></i>
              Atualizar
            </button>
          </div>
          <div class="log-content" id="log-content">
            <div class="log-entry info">
              <span class="log-time">2025-07-29 10:30:15</span>
              <span class="log-level">INFO</span>
              <span class="log-message">Sistema iniciado com sucesso</span>
            </div>
            <div class="log-entry success">
              <span class="log-time">2025-07-29 10:31:20</span>
              <span class="log-level">SUCCESS</span>
              <span class="log-message">Conectado ao dispositivo 192.168.1.100</span>
            </div>
            <div class="log-entry warning">
              <span class="log-time">2025-07-29 10:32:45</span>
              <span class="log-level">WARNING</span>
              <span class="log-message">Timeout na consulta SNMP - tentativa 1/3</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let systemData = {};
    let equipmentData = {};

    // Função para atualizar dados do sistema via API
    async function updateSystemStats() {
      try {
        const response = await fetch('/api/system-data');
        const data = await response.json();
        
        if (response.ok) {
          systemData = data;
          
          // Atualizar IP Tailscale
          document.getElementById('tailscale-ip').textContent = data.tailscaleIP;
          
          // Atualizar temperatura com cores baseadas no valor
          const tempElement = document.getElementById('cpu-temp');
          tempElement.textContent = data.cpuTemp !== 'N/A' ? `${data.cpuTemp}°C` : 'N/A';
          const tempCard = tempElement.closest('.stat-card');
          tempCard.classList.remove('warning', 'critical');
          
          if (data.cpuTemp !== 'N/A') {
            const temp = parseFloat(data.cpuTemp);
            if (temp > 70) {
              tempCard.classList.add('critical');
            } else if (temp > 60) {
              tempCard.classList.add('warning');
            }
          }
          
          // Atualizar outros dados
          document.getElementById('ram-usage').textContent = `${data.ramUsage}%`;
          document.getElementById('disk-usage').textContent = `${data.diskUsage}%`;
          document.getElementById('uptime').textContent = data.uptime;
          document.getElementById('connectivity').textContent = data.connectivity;
          
          // Atualizar indicador de status
          const statusIndicator = document.querySelector('.status-indicator');
          if (data.connectivity === 'Estável') {
            statusIndicator.className = 'status-indicator online';
            statusIndicator.innerHTML = '<i class="fas fa-circle"></i> Online';
          } else {
            statusIndicator.className = 'status-indicator offline';
            statusIndicator.innerHTML = '<i class="fas fa-circle"></i> Offline';
          }
          
          console.log('✅ Dados do sistema atualizados:', data);
        } else {
          console.error('❌ Erro ao obter dados do sistema:', data);
          showError('Erro ao carregar dados do sistema');
        }
      } catch (error) {
        console.error('❌ Erro na requisição:', error);
        showError('Erro de conectividade com o servidor');
      }
    }

    // Função para atualizar dados do equipamento via API
    async function updateEquipmentData() {
      try {
        const response = await fetch('/api/equipment-data');
        const data = await response.json();
        
        if (response.ok) {
          equipmentData = data;
          
          const equipmentBadge = document.getElementById('equipment-badge');
          
          if (data.configured) {
            equipmentBadge.className = 'status-badge online';
            equipmentBadge.textContent = 'Conectado';
            
            // Atualizar medições
            updateMeasurements(data.measurements);
            
            // Atualizar alarmes
            updateAlarms(data.alarms);
            
            console.log('✅ Dados do equipamento atualizados:', data);
            
            if (data.errors && data.errors.length > 0) {
              console.warn('⚠️ Alguns erros ao ler dados:', data.errors);
            }
            
          } else {
            equipmentBadge.className = 'status-badge offline';
            equipmentBadge.textContent = 'Não Configurado';
            showNoEquipmentData();
          }
          
        } else {
          console.error('❌ Erro ao obter dados do equipamento:', data);
          const equipmentBadge = document.getElementById('equipment-badge');
          equipmentBadge.className = 'status-badge error';
          equipmentBadge.textContent = 'Erro';
          showNoEquipmentData();
        }
      } catch (error) {
        console.error('❌ Erro na requisição dos dados do equipamento:', error);
        const equipmentBadge = document.getElementById('equipment-badge');
        equipmentBadge.className = 'status-badge error';
        equipmentBadge.textContent = 'Erro';
        showNoEquipmentData();
      }
    }

    function updateMeasurements(measurements) {
      const measurementKeys = ['forwardPower', 'reflectedPower', 'paTemperature', 'paCurrent', 
                              'powerSupply1_50v', 'powerSupply2_50v', 'satelliteTunerSnr', 'satelliteTunerStatus'];
      
      measurementKeys.forEach(key => {
        const element = document.getElementById(key);
        const card = document.querySelector(`[data-key="${key}"]`);
        
        if (measurements[key]) {
          const measurement = measurements[key];
          element.textContent = `${measurement.value} ${measurement.unit}`;
          
          // Aplicar classes de status baseadas no tipo e valor
          card.classList.remove('normal', 'warning', 'critical');
          
          if (key === 'paTemperature') {
            const temp = parseFloat(measurement.value);
            if (temp > 90) card.classList.add('critical');
            else if (temp > 75) card.classList.add('warning');
            else card.classList.add('normal');
          } else if (key === 'reflectedPower') {
            const power = parseFloat(measurement.value);
            if (power > 50) card.classList.add('warning');
            else card.classList.add('normal');
          } else if (key === 'satelliteTunerStatus') {
            if (measurement.value === 'Locked') card.classList.add('normal');
            else card.classList.add('warning');
          } else {
            card.classList.add('normal');
          }
          
        } else {
          element.textContent = '-- N/A';
          card.classList.remove('normal', 'warning', 'critical');
          card.classList.add('offline');
        }
      });
    }

    function updateAlarms(alarms) {
      const alarmsContainer = document.getElementById('alarms-container');
      const noAlarms = document.getElementById('no-alarms');
      const criticalCount = document.getElementById('critical-alarms');
      const warningCount = document.getElementById('warning-alarms');
      
      // Contar alarmes por severidade
      let criticalAlarms = 0;
      let warningAlarms = 0;
      const activeAlarms = [];
      
      Object.keys(alarms).forEach(key => {
        const alarm = alarms[key];
        if (alarm.active) {
          activeAlarms.push(alarm);
          if (alarm.severity === 'critical') criticalAlarms++;
          else if (alarm.severity === 'warning') warningAlarms++;
        }
      });
      
      // Atualizar contadores
      criticalCount.textContent = criticalAlarms;
      warningCount.textContent = warningAlarms;
      
      // Limpar container
      alarmsContainer.innerHTML = '';
      
      if (activeAlarms.length === 0) {
        alarmsContainer.appendChild(noAlarms);
      } else {
        activeAlarms.forEach(alarm => {
          const alarmElement = document.createElement('div');
          alarmElement.className = `alarm-item ${alarm.severity}`;
          alarmElement.innerHTML = `
            <div class="alarm-icon">
              <i class="fas ${alarm.severity === 'critical' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle'}"></i>
            </div>
            <div class="alarm-content">
              <h4>${alarm.name}</h4>
              <p>${alarm.description}</p>
              <span class="alarm-type">${alarm.type}</span>
            </div>
          `;
          alarmsContainer.appendChild(alarmElement);
        });
      }
    }

    function showNoEquipmentData() {
      // Limpar todas as medições
      const measurementKeys = ['forwardPower', 'reflectedPower', 'paTemperature', 'paCurrent', 
                              'powerSupply1_50v', 'powerSupply2_50v', 'satelliteTunerSnr', 'satelliteTunerStatus'];
      
      measurementKeys.forEach(key => {
        const element = document.getElementById(key);
        const card = document.querySelector(`[data-key="${key}"]`);
        element.textContent = '-- N/A';
        card.classList.remove('normal', 'warning', 'critical');
        card.classList.add('offline');
      });
      
      // Limpar alarmes
      const alarmsContainer = document.getElementById('alarms-container');
      const noAlarms = document.getElementById('no-alarms');
      alarmsContainer.innerHTML = '';
      alarmsContainer.appendChild(noAlarms);
      
      document.getElementById('critical-alarms').textContent = '0';
      document.getElementById('warning-alarms').textContent = '0';
    }

    function showError(message) {
      // Mostrar dados como "Erro" em caso de falha
      document.getElementById('tailscale-ip').textContent = 'Erro';
      document.getElementById('cpu-temp').textContent = 'N/A';
      document.getElementById('ram-usage').textContent = '-%';
      document.getElementById('disk-usage').textContent = '-%';
      document.getElementById('uptime').textContent = 'N/A';
      document.getElementById('connectivity').textContent = 'Erro';
      
      // Adicionar toast de erro (opcional)
      console.warn('⚠️', message);
    }

    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      const button = event.target.closest('.toggle-section');
      const icon = button.querySelector('i');
      
      section.classList.toggle('collapsed');
      
      if (section.classList.contains('collapsed')) {
        icon.style.transform = 'rotate(-90deg)';
      } else {
        icon.style.transform = 'rotate(0deg)';
      }
    }

    function resetForm() {
      document.querySelector('.telemetry-form').reset();
    }

    async function testConnection() {
      const ip = document.getElementById('ip').value;
      const comunidade = document.getElementById('comunidade').value;
      
      if (!ip || !comunidade) {
        alert('Por favor, preencha IP e Comunidade SNMP para testar a conexão.');
        return;
      }
      
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testando...';
      button.disabled = true;
      
      try {
        const response = await fetch('/api/test-snmp', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ ip, comunidade })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('✅ ' + result.message);
          addLogEntry('SUCCESS', `Teste SNMP bem-sucedido para ${ip}`);
        } else {
          alert('❌ ' + result.message);
          addLogEntry('ERROR', `Falha no teste SNMP para ${ip}: ${result.message}`);
        }
      } catch (error) {
        alert('❌ Erro na comunicação com o servidor');
        addLogEntry('ERROR', `Erro na comunicação: ${error.message}`);
      } finally {
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }

    // Interceptar o envio do formulário para usar fetch ao invés de form tradicional
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.querySelector('.telemetry-form');
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
        submitButton.disabled = true;
        
        try {
          const response = await fetch('/salvar', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert('✅ ' + result.message);
            addLogEntry('SUCCESS', `Configuração salva para ${data.ip}`);
          } else {
            alert('❌ ' + result.message);
            addLogEntry('ERROR', `Erro ao salvar configuração: ${result.message}`);
          }
        } catch (error) {
          alert('❌ Erro ao salvar configuração');
          addLogEntry('ERROR', `Erro ao salvar: ${error.message}`);
        } finally {
          submitButton.innerHTML = originalText;
          submitButton.disabled = false;
        }
      });
    });

    function clearLog() {
      document.getElementById('log-content').innerHTML = '';
    }

    async function refreshLog() {
      try {
        const response = await fetch('/api/logs');
        const logs = await response.json();
        
        const logContent = document.getElementById('log-content');
        logContent.innerHTML = '';
        
        logs.forEach(log => {
          addLogEntryDirect(log.level, log.message, log.timestamp);
        });
      } catch (error) {
        console.error('Erro ao carregar logs:', error);
      }
    }

    function addLogEntry(level, message) {
      const now = new Date();
      addLogEntryDirect(level, message, now.toISOString());
    }

    function addLogEntryDirect(level, message, timestamp) {
      const logContent = document.getElementById('log-content');
      const timeStr = new Date(timestamp).toLocaleString('pt-BR');
      
      const entry = document.createElement('div');
      entry.className = `log-entry ${level.toLowerCase()}`;
      entry.innerHTML = `
        <span class="log-time">${timeStr}</span>
        <span class="log-level">${level}</span>
        <span class="log-message">${message}</span>
      `;
      
      logContent.insertBefore(entry, logContent.firstChild);
      
      // Limitar a 50 entradas
      if (logContent.children.length > 50) {
        logContent.removeChild(logContent.lastChild);
      }
    }

    // Validação em tempo real do IP
    document.getElementById('ip').addEventListener('input', function(e) {
      const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
      const isValid = ipPattern.test(e.target.value);
      
      if (e.target.value && !isValid) {
        e.target.classList.add('invalid');
      } else {
        e.target.classList.remove('invalid');
      }
    });

    // Auto-resize do textarea
    document.getElementById('oids').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = this.scrollHeight + 'px';
    });

    // Inicializar dados do sistema
    updateSystemStats();
    updateEquipmentData();
    
    // Atualizar dados do sistema a cada 30 segundos
    setInterval(updateSystemStats, 30000);
    
    // Atualizar dados do equipamento a cada 15 segundos (mais frequente para alarmes)
    setInterval(updateEquipmentData, 15000);
    
    // Log de inicialização
    addLogEntry('INFO', 'Dashboard carregado com sucesso');
  </script>
</body>
</html>
